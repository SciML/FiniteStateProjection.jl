<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Troubleshooting · FiniteStateProjection.jl</title><script data-outdated-warner src="assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="assets/documenter.js"></script><script src="siteinfo.js"></script><script src="../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="index.html">FiniteStateProjection.jl</a></span></div><form class="docs-search" action="search.html"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="index.html">Home</a></li><li><a class="tocitem" href="mainapi.html">Main API</a></li><li><a class="tocitem" href="indexhandlers.html">Index Handlers</a></li><li><a class="tocitem" href="matrix.html">Matrix Conversions</a></li><li><a class="tocitem" href="internal.html">Internal API</a></li><li><a class="tocitem" href="tips.html">Tips &amp; Tricks</a></li><li class="is-active"><a class="tocitem" href="troubleshoot.html">Troubleshooting</a><ul class="internal"><li><a class="tocitem" href="#Ensure-your-state-space-has-the-right-dimension"><span>Ensure your state space has the right dimension</span></a></li><li><a class="tocitem" href="#Ensure-your-state-space-is-big-enough"><span>Ensure your state space is big enough</span></a></li><li><a class="tocitem" href="#Ensure-your-propensities-are-positive"><span>Ensure your propensities are positive</span></a></li><li><a class="tocitem" href="#Ensure-you-are-using-the-right-solver"><span>Ensure you are using the right solver</span></a></li></ul></li><li><a class="tocitem" href="examples.html">Examples</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href="troubleshoot.html">Troubleshooting</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href="troubleshoot.html">Troubleshooting</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/kaandocal/FiniteStateProjection.jl/blob/main/docs/src/troubleshoot.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="troubleshoot"><a class="docs-heading-anchor" href="#troubleshoot">Troubleshooting</a><a id="troubleshoot-1"></a><a class="docs-heading-anchor-permalink" href="#troubleshoot" title="Permalink"></a></h1><p>Solving the Chemical Master Equation numerically is a difficult task and errors are liable to crop up. The following section presents some ways to catch common errors.</p><h2 id="Ensure-your-state-space-has-the-right-dimension"><a class="docs-heading-anchor" href="#Ensure-your-state-space-has-the-right-dimension">Ensure your state space has the right dimension</a><a id="Ensure-your-state-space-has-the-right-dimension-1"></a><a class="docs-heading-anchor-permalink" href="#Ensure-your-state-space-has-the-right-dimension" title="Permalink"></a></h2><p>If your are solving an SIR model with three species, <span>$S$</span>, <span>$I$</span> and <span>$R$</span>, your state space will be 3-dimensional. FiniteStateProjection.jl computes probabilities for all states simultaneously and stores the results in a 3-dimensional array. In particular, <code>u0</code> must have type <code>Float64</code> (or similar).</p><pre><code class="language-julia hljs"># correct
u0 = zeros(101, 101, 101)
u0[100,2,1] = 1.0           # start with 1 infected and 99 susceptible individuals

# incorrect
u0 = [99,1,0]               # wrong type (Int) and shape (1D)</code></pre><h2 id="Ensure-your-state-space-is-big-enough"><a class="docs-heading-anchor" href="#Ensure-your-state-space-is-big-enough">Ensure your state space is big enough</a><a id="Ensure-your-state-space-is-big-enough-1"></a><a class="docs-heading-anchor-permalink" href="#Ensure-your-state-space-is-big-enough" title="Permalink"></a></h2><p>A common reason for the solver returning nonsensical solutions is a state space that is too small. Since the Finite State Projection works with a finite-dimensional approximation of the system, the number of states considered can have a large impact on accuracy. The loss of accuracy due to using a smaller state space is the truncation error.</p><p>A good way to check whether your state space is large enough is to solve the CME until the required time <span>$t$</span> and to sum up the probabilities for each state - this gives the probability that the system will have remained in the truncated state space from start to end. If this quantity is noticeably less than 1, the state space is likely too small. As an informal rule of thumb, a value of less than <span>$95\%$</span> indicates that the solution will not be reliable.</p><pre><code class="language-julia hljs"># always true
sum(u0) == 1                # our initial condition lies in the truncated state space

# good
sum(ut) &gt;= 0.99             # our truncation covers most of the relevant states

# bad
sum(ut) &lt; 0.95              # we do not have enough coverage</code></pre><p>The above does not work directly when computing steady-state probabilities as the value will usually drop to 0 for large enough <span>$t$</span>. In this case it is a good idea to redo the computation with a larger state space - the results should agree if the truncation error is small.</p><h2 id="Ensure-your-propensities-are-positive"><a class="docs-heading-anchor" href="#Ensure-your-propensities-are-positive">Ensure your propensities are positive</a><a id="Ensure-your-propensities-are-positive-1"></a><a class="docs-heading-anchor-permalink" href="#Ensure-your-propensities-are-positive" title="Permalink"></a></h2><p>This point might seem obvious, but errors in the rate functions, or an incorrectly chosen truncation, can lead to negative reaction propensities that will typically result in numerical instabilities. As an example, consider the following version of the SI model where the population size <span>$S + I = N$</span> is constant, allowing us to rewrite the system using only one species <span>$I$</span> (with <span>$S = N - I$</span>):</p><pre><code class="language-julia hljs">rn = @reaction_network begin
   σ * (N - I), I --&gt; 2I
   ρ, I --&gt; 0
end σ ρ N

sys_fsp = FSPSystem(rn)</code></pre><p>Here the propensity function for the first reaction will negative if <span>$I &gt; N$</span>, so the following may result in numerical instabilities:</p><pre><code class="language-julia hljs">u0 = zeros(30)
u0[2] = 1

prob_fsp = convert(ODEProblem, sys_fsp, u0, (0, 100.), [ 1., 1., 20 ])      # N is too small for the state space!</code></pre><h2 id="Ensure-you-are-using-the-right-solver"><a class="docs-heading-anchor" href="#Ensure-you-are-using-the-right-solver">Ensure you are using the right solver</a><a id="Ensure-you-are-using-the-right-solver-1"></a><a class="docs-heading-anchor-permalink" href="#Ensure-you-are-using-the-right-solver" title="Permalink"></a></h2><p>The Chemical Master Equation is generally very stiff and requires a solver that can handle this stiffness, see <a href="tips.html#tips">Tips &amp; Tricks</a>. If your solver fails, first check if any of the above points apply. You may be able to get a different solver to work; this requires some experimentation. Anecdotally some systems, particularly oscillatory ones such as the Schlögl model, can pose significant challenges to most solvers and take inordinate amounts of time to solve. I am not aware of any solutions for this issue and would appreciate any tips for getting such systems to work (please consider opening an issue on GitHub if you encounter such examples).</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="tips.html">« Tips &amp; Tricks</a><a class="docs-footer-nextpage" href="examples.html">Examples »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.24 on <span class="colophon-date" title="Thursday 16 February 2023 12:43">Thursday 16 February 2023</span>. Using Julia version 1.6.7.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
